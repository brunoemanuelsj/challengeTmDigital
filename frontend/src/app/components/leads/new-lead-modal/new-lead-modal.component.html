<p-dialog
  [(visible)]="visible"
  [modal]="true"
  [style]="{ width: '900px', maxWidth: '95vw' }"
  [draggable]="false"
  [resizable]="false"
  (onHide)="close()"
  header=" "
  styleClass="custom-modal"
>
  <ng-template pTemplate="header">
    <div style="display: flex; align-items: center; gap: 0.5rem">
      <i class="pi pi-user-plus text-primary text-xl"></i>
      <span class="font-bold text-xl">Novo Lead</span>
    </div>
  </ng-template>

  <form [formGroup]="leadForm" class="mt-2">
    <!-- Seção: Dados do Lead -->
    <div class="mb-4">
      <h3 class="section-title">
        <i class="pi pi-id-card"></i>
        Dados Pessoais
      </h3>

      <div class="form-grid">
        <div class="field col-6">
          <label for="nome" class="required">Nome Completo</label>
          <input
            pInputText
            id="nome"
            formControlName="nome"
            placeholder="Ex: João da Silva"
            [ngClass]="{ 'ng-invalid ng-dirty': isFieldInvalid('nome') }"
          />
          <div class="error-message" *ngIf="isFieldInvalid('nome')">
            <i class="pi pi-exclamation-circle"></i>
            <span>Nome é obrigatório</span>
          </div>
        </div>

        <div class="field col-6">
          <label for="cpf" class="required">CPF</label>
          <input
            pInputText
            id="cpf"
            formControlName="cpf"
            placeholder="000.000.000-00"
            [ngClass]="{ 'ng-invalid ng-dirty': isFieldInvalid('cpf') }"
          />
          <div class="error-message" *ngIf="isFieldInvalid('cpf')">
            <i class="pi pi-exclamation-circle"></i>
            <span>CPF é obrigatório</span>
          </div>
        </div>

        <div class="field col-6">
          <label for="email" class="required">Email</label>
          <input
            pInputText
            id="email"
            formControlName="email"
            placeholder="exemplo@email.com"
            [ngClass]="{ 'ng-invalid ng-dirty': isFieldInvalid('email') }"
          />
          <div class="error-message" *ngIf="isFieldInvalid('email')">
            <i class="pi pi-exclamation-circle"></i>
            <span>Email inválido ou obrigatório</span>
          </div>
        </div>

        <div class="field col-6">
          <label for="telefone" class="required">Telefone</label>
          <input
            pInputText
            id="telefone"
            formControlName="telefone"
            placeholder="(00) 00000-0000"
            [ngClass]="{ 'ng-invalid ng-dirty': isFieldInvalid('telefone') }"
          />
          <div class="error-message" *ngIf="isFieldInvalid('telefone')">
            <i class="pi pi-exclamation-circle"></i>
            <span>Telefone é obrigatório</span>
          </div>
        </div>

        <div class="field col-12">
          <label for="comentarios">Observações</label>
          <textarea
            pTextarea
            id="comentarios"
            formControlName="comentarios"
            rows="3"
            placeholder="Adicione informações relevantes sobre o lead..."
          ></textarea>
        </div>
      </div>
    </div>

    <!-- Seção: Propriedades Rurais -->
    <div class="properties-section">
      <div class="properties-header">
        <h3 class="section-title mb-0">
          <i class="pi pi-map"></i>
          Propriedades Rurais
        </h3>
        <p-button
          label="Adicionar Propriedade"
          icon="pi pi-plus"
          size="small"
          [outlined]="true"
          (onClick)="addProperty()"
        ></p-button>
      </div>

      <div formArrayName="propriedades">
        <!-- Empty State -->
        <div *ngIf="propriedades.length === 0" class="empty-state">
          <i class="pi pi-home"></i>
          <p>Nenhuma propriedade adicionada.</p>
          <small>Clique em "Adicionar Propriedade" para incluir áreas rurais.</small>
        </div>

        <!-- Lista de Propriedades -->
        <div
          *ngFor="let prop of propriedades.controls; let i = index"
          [formGroupName]="i"
          class="property-card"
        >
          <div class="card-header">
            <span class="card-title">Propriedade #{{ i + 1 }}</span>
            <p-button
              icon="pi pi-trash"
              [rounded]="true"
              [text]="true"
              severity="danger"
              pTooltip="Remover propriedade"
              (onClick)="removeProperty(i)"
            ></p-button>
          </div>

          <div class="form-grid mb-0">
            <div class="field col-6">
              <label [for]="'prop_nome_' + i" class="required">Nome da Propriedade</label>
              <input
                pInputText
                [id]="'prop_nome_' + i"
                formControlName="nome"
                placeholder="Ex: Fazenda Santa Luzia"
                [ngClass]="{ 'ng-invalid ng-dirty': isPropertyFieldInvalid(i, 'nome') }"
              />
              <div class="error-message" *ngIf="isPropertyFieldInvalid(i, 'nome')">
                <i class="pi pi-exclamation-circle"></i>
                <span>Nome obrigatório</span>
              </div>
            </div>

            <div class="field col-6">
              <label [for]="'prop_cultura_' + i" class="required">Cultura Principal</label>
              <input
                pInputText
                [id]="'prop_cultura_' + i"
                formControlName="cultura"
                placeholder="Ex: Soja, Milho, Café"
                [ngClass]="{ 'ng-invalid ng-dirty': isPropertyFieldInvalid(i, 'cultura') }"
              />
              <div class="error-message" *ngIf="isPropertyFieldInvalid(i, 'cultura')">
                <i class="pi pi-exclamation-circle"></i>
                <span>Cultura obrigatória</span>
              </div>
            </div>

            <div class="field col-4">
              <label [for]="'prop_area_' + i" class="required">Área (ha)</label>
              <p-inputNumber
                [id]="'prop_area_' + i"
                formControlName="area_hectares"
                mode="decimal"
                [minFractionDigits]="2"
                [maxFractionDigits]="2"
                placeholder="0,00"
                [ngClass]="{ 'ng-invalid ng-dirty': isPropertyFieldInvalid(i, 'area_hectares') }"
              ></p-inputNumber>
              <div class="error-message" *ngIf="isPropertyFieldInvalid(i, 'area_hectares')">
                <i class="pi pi-exclamation-circle"></i>
                <span>Área obrigatória</span>
              </div>
            </div>

            <div class="field col-4">
              <label [for]="'prop_municipio_' + i" class="required">Município</label>
              <input
                pInputText
                [id]="'prop_municipio_' + i"
                formControlName="municipio"
                [ngClass]="{ 'ng-invalid ng-dirty': isPropertyFieldInvalid(i, 'municipio') }"
              />
              <div class="error-message" *ngIf="isPropertyFieldInvalid(i, 'municipio')">
                <i class="pi pi-exclamation-circle"></i>
                <span>Município obrigatório</span>
              </div>
            </div>

            <div class="field col-4">
              <label [for]="'prop_estado_' + i" class="required">Estado (UF)</label>
              <input
                pInputText
                [id]="'prop_estado_' + i"
                formControlName="estado"
                placeholder="UF"
                maxlength="2"
                [ngClass]="{ 'ng-invalid ng-dirty': isPropertyFieldInvalid(i, 'estado') }"
              />
              <div class="error-message" *ngIf="isPropertyFieldInvalid(i, 'estado')">
                <i class="pi pi-exclamation-circle"></i>
                <span>Estado obrigatório</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </form>

  <ng-template pTemplate="footer">
    <div class="flex justify-content-end gap-2 pt-3">
      <p-button
        label="Cancelar"
        icon="pi pi-times"
        [text]="true"
        severity="secondary"
        (onClick)="close()"
        [disabled]="loading()"
      ></p-button>
      <p-button
        label="Salvar Lead"
        icon="pi pi-check"
        (onClick)="save()"
        [loading]="loading()"
        [disabled]="loading()"
      ></p-button>
    </div>
  </ng-template>
</p-dialog>
